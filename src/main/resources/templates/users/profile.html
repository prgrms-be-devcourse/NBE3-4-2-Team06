<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ë§ˆì´í˜ì´ì§€</title>
    <link rel="stylesheet" href="/css/profile.css">
    <script src="/js/header.js"></script>
</head>
<body>

<!-- âœ… í—¤ë” -->
<div th:replace="~{fragments/header :: header}"></div>

<div class="profile-container">
    <div class="title-container">
        <h2>ë§ˆì´í˜ì´ì§€</h2>
        <button id="manageAccountBtn" class="account-btn">ê³„ì¢Œ ê´€ë¦¬</button>
        <button id="editProfileBtn" class="edit-btn">ìˆ˜ì •í•˜ê¸°</button>
    </div>

    <p><strong>ì‚¬ìš©ì ID:</strong> <span id="userName" th:text="${name}"></span></p>
    <p><strong>ì´ë©”ì¼:</strong> <span id="userEmail" th:text="${email}"></span></p>
    <p><strong>ì—­í• :</strong> <span id="userRole" th:text="${role}"></span></p>
    <p><strong>ê°€ì…ì¼:</strong> <span id="userCreatedAt" th:text="${createdAt}"></span></p>
    <p><strong>ìµœê·¼ ìˆ˜ì •ì¼:</strong> <span id="userUpdatedAt" th:text="${updatedAt}"></span></p>
</div>
<!-- ìˆ˜ì •í•˜ê¸° ë²„íŠ¼ -->
<!-- âœ… ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸° -->
<script>
    document.addEventListener("DOMContentLoaded", async function () {
      const token = localStorage.getItem("accessToken");
      const username = window.location.pathname.split("/").pop(); // URLì—ì„œ username ì¶”ì¶œ

      if (!token) {
          console.warn("âŒ JWT í† í° ì—†ìŒ! ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
          alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
          window.location.href = "/api/users/login";
          return;
      }

      console.log("ğŸ”¹ ì €ì¥ëœ JWT í† í°:", token);

      try {
          console.log(`ğŸ“Œ ì„œë²„ì— ìš”ì²­ ì¤‘: GET /api/users/profile/${username}`);
          const response = await fetch(`/api/users/profile/${username}`, {
              method: "GET",
              headers: {
                  "Authorization": `Bearer ${token}`, // âœ… JWT í† í° í¬í•¨
                  "Content-Type": "application/json"
              }
          });

          console.log("ğŸ“Œ ìš”ì²­ í—¤ë” í™•ì¸:", {
              "Authorization": `Bearer ${token}`,
              "Content-Type": "application/json"
          });

          if (!response.ok) {
              console.error(`âŒ ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ${response.status} - ${response.statusText}`);
              const errorText = await response.text();
              console.error("ğŸ“Œ ì„œë²„ ì‘ë‹µ ë³¸ë¬¸ (ì›ë³¸ ì˜¤ë¥˜ ë©”ì‹œì§€):", errorText);
              throw new Error(`ì„œë²„ ì˜¤ë¥˜: ${response.status}`);
          }

          const data = await response.json();
          console.log("ğŸ“Œ ì„œë²„ ì‘ë‹µ ë°ì´í„° (ì›ë³¸):", data);

          if (!data.data) {
              throw new Error("ì‚¬ìš©ì ë°ì´í„°ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
          }

          // âœ… í”„ë¡œí•„ ë°ì´í„° ë°˜ì˜
          document.getElementById("userName").textContent = data.data.name || "N/A";
          document.getElementById("userEmail").textContent = data.data.email || "N/A";
          document.getElementById("userRole").textContent = data.data.role || "N/A";
          document.getElementById("userCreatedAt").textContent = new Date(data.data.createdAt).toISOString().split("T")[0];
          document.getElementById("userUpdatedAt").textContent = new Date(data.data.updatedAt).toISOString().split("T")[0];

          console.log("âœ… í”„ë¡œí•„ ë°ì´í„° ë°˜ì˜ ì™„ë£Œ.");
      } catch (error) {
          console.error("âŒ í”„ë¡œí•„ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", error);
          alert("í”„ë¡œí•„ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì˜¤ë¥˜: " + error.message);
      }
  });
</script>

<!-- âœ… ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const username = window.location.pathname.split("/").pop(); // URLì—ì„œ username ì¶”ì¶œ

        // âœ… ìˆ˜ì • ë²„íŠ¼
        const editProfileBtn = document.getElementById("editProfileBtn");
        if (editProfileBtn) {
            editProfileBtn.addEventListener("click", function () {
                const popup = window.open(`/profile/modify/${username}`, "EditProfilePopup", "width=500,height=400,scrollbars=no");
                if (!popup) {
                    alert("íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. íŒì—… ì°¨ë‹¨ì„ í•´ì œí•´ì£¼ì„¸ìš”.");
                }
            });
        } else {
            console.error("âŒ ìˆ˜ì • ë²„íŠ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }

        // âœ… ê³„ì¢Œ ê´€ë¦¬ ë²„íŠ¼
        const manageAccountBtn = document.getElementById("manageAccountBtn");
        if (manageAccountBtn) {
            manageAccountBtn.addEventListener("click", function () {
                window.location.href = `/profile/account/${username}`;
            });
        } else {
            console.error("âŒ ê³„ì¢Œ ê´€ë¦¬ ë²„íŠ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        }
    });
</script>

</body>
</html>
