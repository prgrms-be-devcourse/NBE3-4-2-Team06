<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ë§ˆì´í˜ì´ì§€</title>
    <link rel="stylesheet" href="/css/profile.css">
    <script src="/js/header.js"></script>
</head>
<body>

<!-- âœ… í—¤ë” ì¤‘ë³µ ë°©ì§€: body ë‚´ë¶€ì—ì„œ í•œ ë²ˆë§Œ ë¶ˆëŸ¬ì˜¤ê¸° -->
<div th:replace="~{fragments/header :: header}"></div>

<div class="profile-container">
    <div class="title-container">
        <h2>ë§ˆì´í˜ì´ì§€</h2>
        <button id="editProfileBtn" class="edit-btn">ìˆ˜ì •í•˜ê¸°</button>
    </div>

    <p><strong>ì‚¬ìš©ì ID:</strong> <span id="userName" th:text="${name}"></span></p>
    <p><strong>ì´ë©”ì¼:</strong> <span id="userEmail" th:text="${email}"></span></p>
    <p><strong>ì—­í• :</strong> <span id="userRole" th:text="${role}"></span></p>
    <p><strong>ê°€ì…ì¼:</strong> <span id="userCreatedAt" th:text="${createdAt}"></span></p>
    <p><strong>ìµœê·¼ ìˆ˜ì •ì¼:</strong> <span id="userUpdatedAt" th:text="${updatedAt}"></span></p>
</div>

<!-- ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸° -->
<script>
    document.addEventListener("DOMContentLoaded", async function () {
      const token = localStorage.getItem("accessToken");
      const username = window.location.pathname.split("/").pop(); // URLì—ì„œ username ì¶”ì¶œ

      if (!token) {
          alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
          window.location.href = "/api/users/login";
          return;
      }

      console.log("ğŸ”¹ ì €ì¥ëœ JWT í† í°:", token);

      // ğŸ”¹ JWTì—ì„œ ì‚¬ìš©ì ì •ë³´ ì¶”ì¶œ (ëª¨ë“  Claims í™•ì¸)
      let loggedInUser = null;
      let jwtRole = null;

      try {
          const payload = JSON.parse(atob(token.split(".")[1]));
          console.log("ğŸ“Œ JWT Payload ì „ì²´ ë°ì´í„°:", payload);

          loggedInUser = payload.sub;  // JWTì˜ subject (username)
          jwtRole = payload.role;  // role ì •ë³´

          console.log("ğŸ“Œ JWTì—ì„œ ì¶”ì¶œëœ ì‚¬ìš©ì ID:", loggedInUser);
          console.log("ğŸ“Œ JWTì—ì„œ ì¶”ì¶œëœ ì—­í• :", jwtRole);
      } catch (error) {
          console.error("âŒ JWT ë””ì½”ë”© ì˜¤ë¥˜:", error);
          alert("ì˜ëª»ëœ ë¡œê·¸ì¸ ì •ë³´ì…ë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
          localStorage.removeItem("accessToken");
          window.location.href = "/api/users/login";
          return;
      }

      try {
          // âœ… ì„œë²„ì— í”„ë¡œí•„ ìš”ì²­ (í´ë¼ì´ì–¸íŠ¸ â†’ ì„œë²„)
          console.log(`ğŸ“Œ ì„œë²„ì— ìš”ì²­ ì¤‘: GET /api/users/profile/${username}`);
          const response = await fetch(`/api/users/profile/${username}`, {
              method: "GET",
              headers: {
                  "Authorization": `Bearer ${token}`,
                  "Content-Type": "application/json"
              }
          });

          console.log("ğŸ“Œ ìš”ì²­ í—¤ë”:", {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json"
          });

          // âœ… ì„œë²„ ì‘ë‹µ ìƒíƒœ ì½”ë“œ í™•ì¸
          console.log("ğŸ“Œ ì„œë²„ ì‘ë‹µ ìƒíƒœ ì½”ë“œ:", response.status);

          if (!response.ok) {
              console.error(`âŒ ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ${response.status} - ${response.statusText}`);
              const errorText = await response.text();
              console.error("ğŸ“Œ ì„œë²„ ì‘ë‹µ ë³¸ë¬¸ (ì›ë³¸ ì˜¤ë¥˜ ë©”ì‹œì§€):", errorText);
              throw new Error(`ì„œë²„ ì˜¤ë¥˜: ${response.status}`);
          }

          // âœ… ì„œë²„ ì‘ë‹µ JSON ë°ì´í„° í™•ì¸
          const data = await response.json();
          console.log("ğŸ“Œ ì„œë²„ ì‘ë‹µ ë°ì´í„° (ì›ë³¸):", data);

          if (!data.data) {
              throw new Error("ì‚¬ìš©ì ë°ì´í„°ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
          }

          // âœ… ì„œë²„ì—ì„œ ê°€ì ¸ì˜¨ ë°ì´í„° ì¶œë ¥
          console.log("ğŸ“Œ ì„œë²„ì—ì„œ ê°€ì ¸ì˜¨ ì‚¬ìš©ì ë°ì´í„°:");
          console.log("   - ì‚¬ìš©ìëª…:", data.data.name);
          console.log("   - ì´ë©”ì¼:", data.data.email);
          console.log("   - ì—­í• :", data.data.role);
          console.log("   - ê°€ì…ì¼:", data.data.createdAt);
          console.log("   - ìµœê·¼ ìˆ˜ì •ì¼:", data.data.updatedAt);

          // ë‚ ì§œ ë³€í™˜ í•¨ìˆ˜
          const formatDate = (isoString) => {
              if (!isoString) return "N/A";
              return new Date(isoString).toISOString().split("T")[0];
          };

          // ì—­í•  ë³€í™˜ (ì˜ì–´ â†’ í•œê¸€)
          const roleTranslation = {
              "ADMIN": "ê´€ë¦¬ì",
              "_BENEFICIARY": "ìˆ˜í˜œì",
              "SPONSOR": "í›„ì›ì"
          };

          const translatedRole = roleTranslation[data.data.role] || "ì•Œ ìˆ˜ ì—†ëŠ” ì—­í• ";

          // âœ… ì„œë²„ì—ì„œ ë°›ì•„ì˜¨ ì •ë³´ë¡œ UI ì—…ë°ì´íŠ¸
          document.getElementById("userName").textContent = data.data.name || "N/A";
          document.getElementById("userEmail").textContent = data.data.email || "N/A";
          document.getElementById("userRole").textContent = translatedRole;
          document.getElementById("userCreatedAt").textContent = formatDate(data.data.createdAt);
          document.getElementById("userUpdatedAt").textContent = formatDate(data.data.updatedAt);

          console.log("âœ… ìµœì¢… ë³€í™˜ëœ ì—­í•  (í•œê¸€):", translatedRole);
          console.log("âœ… í”„ë¡œí•„ ë°ì´í„° ë°˜ì˜ ì™„ë£Œ.");
      } catch (error) {
          console.error("âŒ í”„ë¡œí•„ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", error);
          alert("í”„ë¡œí•„ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì˜¤ë¥˜: " + error.message);
      }
  });
</script>

<script>
    document.getElementById("editProfileBtn").addEventListener("click", function () {
        const username = window.location.pathname.split("/").pop(); // URLì—ì„œ username ê°€ì ¸ì˜¤ê¸°
        const popup = window.open(`/profile/modify/${username}`, "EditProfilePopup", "width=500,height=400,scrollbars=no");

        if (!popup) {
            alert("íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. íŒì—… ì°¨ë‹¨ì„ í•´ì œí•´ì£¼ì„¸ìš”.");
        }
    });
</script>

</body>
</html>