<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§ˆì´ í˜ì´ì§€</title>
    <link rel="stylesheet" th:href="@{/css/profile.css}">
</head>
<body>
<div th:replace="~{fragments/header :: header}"></div>

<main id="mainContent"></main>

<script>
    document.addEventListener("DOMContentLoaded", async function () {
     const token = localStorage.getItem("accessToken");
     const username = window.location.pathname.split("/").pop();

     if (!token) {
         alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
         window.location.href = "/api/users/login";
         return;
     }

     let userRole = null;

     // JWT í† í° ë””ì½”ë”©í•˜ì—¬ ì—­í•  í™•ì¸
     try {
         const tokenPayload = JSON.parse(atob(token.split(".")[1]));
         userRole = tokenPayload.role || "ROLE_UNKNOWN";
         console.log("ì‚¬ìš©ì ì—­í• :", userRole);  // ë””ë²„ê¹… ë¡œê·¸
     } catch (error) {
         console.error("JWT ë””ì½”ë”© ì˜¤ë¥˜:", error);
         alert("ì¸ì¦ ì •ë³´ ì˜¤ë¥˜. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
         window.location.href = "/api/users/login";
         return;
     }

     try {
         // ğŸ”¹ í”„ë¡œí•„ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
         const response = await fetch(`/api/users/profile/${username}`, {
             method: "GET",
             headers: {
                 "Authorization": `Bearer ${token}`,
                 "Content-Type": "application/json"
             }
         });

         if (!response.ok) {
             const errorText = await response.text();
             throw new Error(`ì„œë²„ ì˜¤ë¥˜: ${response.status}, ${errorText}`);
         }

         const data = await response.json();
         console.log("í”„ë¡œí•„ ë°ì´í„°:", data);

         if (!data.data) {
             throw new Error("ì‚¬ìš©ì ë°ì´í„°ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
         }

         const userInfo = data.data;
         const mainContent = document.getElementById("mainContent");

         // ê¸°ë³¸ ì‚¬ìš©ì ì •ë³´ í‘œì‹œ
         let profileHTML = `
             <section class="profile-section">
                 <div class="profile-pic">
                     <button class="btn inquiry">ë¬¸ì˜í•˜ê¸°</button>
                 </div>
                 <div class="profile-info">
                     <h2>ë‚´ ì •ë³´</h2>
                     <p>ì´ë¦„: ${userInfo.name}</p>
                     <p>Email: ${userInfo.email}</p>
                     <p>ì—­í• : ${userInfo.role}</p>
                     <p>ê°€ìƒ ê³„ì¢Œ: (${userInfo.name})</p>
                     <button class="btn info-change">ë‚´ ì •ë³´ ë³€ê²½í•˜ê¸°</button>
                     <button class="btn create-account">ê³„ì¢Œê´€ë¦¬</button>
                 </div>
             </section>
         `;

         // **í›„ì›ì(ROLE_SPONSOR)**ì¼ ë•Œ í›„ì› í”„ë¡œì íŠ¸ í˜„í™© ì¶”ê°€
         if (userRole === "ROLE_SPONSOR") {
             profileHTML += `
                 <section class="project-status">
                     <h2>í›„ì› í”„ë¡œì íŠ¸ í˜„í™©</h2>
                     <table>
                         <thead>
                             <tr>
                                 <th>í”„ë¡œì íŠ¸ íƒ€ì´í‹€</th>
                                 <th>í›„ì› ê¸ˆì•¡</th>
                                 <th>í›„ì› ì¼ì</th>
                                 <th>ìƒíƒœ</th>
                                 <th>ìŠ¹ì¸ì—¬ë¶€</th>
                             </tr>
                         </thead>
                         <tbody id="fundingProjects">
                             <!-- í›„ì›í•œ í”„ë¡œì íŠ¸ ë°ì´í„°ê°€ ì—¬ê¸°ì— ì‚½ì…ë©ë‹ˆë‹¤ -->
                         </tbody>
                     </table>
                 </section>
             `;
         }

         // **ìˆ˜í˜œì(ROLE_BENEFICIARY)**ì¼ ë•Œ 'ë‚´ í”„ë¡œì íŠ¸ í˜„í™©' ì¶”ê°€
         if (userRole === "ROLE_BENEFICIARY") {
             profileHTML += `
                 <section class="my-projects">
                     <h2>ë‚´ í”„ë¡œì íŠ¸ í˜„í™©</h2>
                     <table>
                         <thead>
                             <tr>
                                 <th>í”„ë¡œì íŠ¸ íƒ€ì´í‹€</th>
                                 <th>ëª©í‘œì•¡</th>
                                 <th>í”„ë¡œì íŠ¸ ìƒì„±ì¼</th>
                                 <th>ìƒíƒœ</th>
                                 <th>ìŠ¹ì¸ì—¬ë¶€</th>

                             </tr>
                         </thead>
                         <tbody id="myProjects">
                             <!-- ìƒì„±í•œ í”„ë¡œì íŠ¸ ë°ì´í„°ê°€ ì—¬ê¸°ì— ì‚½ì…ë©ë‹ˆë‹¤ -->
                         </tbody>
                     </table>
                 </section>
             `;
         }

         // ë‚˜ë¨¸ì§€ ì„¹ì…˜ ì¶”ê°€
         profileHTML += `
             <section class="inquiries">
                 <h2>ë‚´ ë¬¸ì˜ ëª©ë¡</h2>
                 <table>
                     <thead>
                         <tr>
                             <th>ë¬¸ì˜ ì œëª©</th>
                             <th>ì‘ì„± ì¼ì</th>
                             <th>ìˆ˜ì • ì¼ì</th>
                             <th>ë‹µë³€ ìƒíƒœ</th>
                         </tr>
                     </thead>
                     <tbody>
                         <tr>
                             <td>ë¬¸ì˜ìˆìŠµë‹ˆë‹¤. 1</td>
                             <td>2025.02.08</td>
                             <td>2025.02.09</td>
                             <td>ë‹µë³€ ì™„ë£Œ</td>
                         </tr>
                         <tr>
                             <td>ë¬¸ì˜ìˆìŠµë‹ˆë‹¤. 2</td>
                             <td>2025.02.08</td>
                             <td>2025.02.08</td>
                             <td>ëŒ€ê¸°ì¤‘</td>
                             <td>
                                 <button class="btn edit">ìˆ˜ì •</button>
                                 <button class="btn cancel">ì·¨ì†Œ</button>
                             </td>
                         </tr>
                     </tbody>
                 </table>
             </section>
         `;

         mainContent.innerHTML = profileHTML;

         // **í›„ì›ìì¼ ê²½ìš° í›„ì› ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°**
         if (userRole === "ROLE_SPONSOR") {
             const fundingResponse = await fetch(`/api/users/fundings/${username}`, {
                 method: "GET",
                 headers: {
                     "Authorization": `Bearer ${token}`,
                     "Content-Type": "application/json"
                 }
             });

             if (!fundingResponse.ok) {
                 const errorText = await fundingResponse.text();
                 throw new Error(`ì„œë²„ ì˜¤ë¥˜: ${fundingResponse.status}, ${errorText}`);
             }

             const fundingData = await fundingResponse.json();
             console.log("í›„ì› í”„ë¡œì íŠ¸ ë°ì´í„°:", fundingData);

             const fundingProjects = document.getElementById("fundingProjects");
             fundingProjects.innerHTML = '';

             fundingData.data.forEach(funding => {
                 const row = `
                     <tr>
                         <td>${funding.projectTitle}</td>
                         <td>${funding.fundingAmount ? funding.fundingAmount.toLocaleString() : '0'}ì›</td>
                         <td>${funding.fundedAt ? new Date(funding.fundedAt).toISOString().split('T')[0] : 'N/A'}</td>
                         <td>${funding.status === 'SUCCESS' ? 'ì„±ê³µ' : funding.status === 'FAILED' ? 'ì‹¤íŒ¨' : 'ì§„í–‰ì¤‘'}</td>
                         <td>${funding.transactionStatus || 'N/A'}</td>
                     </tr>
                 `;
                 fundingProjects.insertAdjacentHTML('beforeend', row);
             });
         }

         // **ìˆ˜í˜œìì¼ ê²½ìš° ìƒì„±í•œ í”„ë¡œì íŠ¸ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°**
         if (userRole === "ROLE_BENEFICIARY") {
             const projectsResponse = await fetch(`/api/users/projects/${username}`, {
                 method: "GET",
                 headers: {
                     "Authorization": `Bearer ${token}`,
                     "Content-Type": "application/json"
                 }
             });

             if (!projectsResponse.ok) {
                 const errorText = await projectsResponse.text();
                 throw new Error(`ì„œë²„ ì˜¤ë¥˜: ${projectsResponse.status}, ${errorText}`);
             }

             const projectsData = await projectsResponse.json();
             console.log("ë‚´ í”„ë¡œì íŠ¸ ë°ì´í„°:", projectsData);

             const myProjects = document.getElementById("myProjects");
             myProjects.innerHTML = '';

           projectsData.data.forEach(project => {
            const row = `
                <tr>
                    <td>${project.title}</td>
                    <td>${project.fundingGoal ? project.fundingGoal.toLocaleString() : '0'}ì›</td>
                    <td>${new Date(project.createdAt).toISOString().split('T')[0]}</td>
                    <td>${project.status === 'SUCCESS' ? 'ì„±ê³µ' : project.status === 'FAILED' ? 'ì‹¤íŒ¨' : 'ì§„í–‰ì¤‘'}</td>
                    <td>${project.isApproved === 'APPROVE' ? 'ìŠ¹ì¸' : project.isApproved === 'REJECTED' ? 'ê±°ì ˆ' : 'ìŠ¹ì¸ëŒ€ê¸°'}</td>
                    <td>
                        <button class="btn edit">ìˆ˜ì •</button>
                        <button class="btn cancel">ì·¨ì†Œ</button>
                    </td>
                </tr>
            `;
            myProjects.insertAdjacentHTML('beforeend', row);
        });
         }

     } catch (error) {
         console.error("ì—ëŸ¬ ë°œìƒ:", error);
         alert("í”„ë¡œí•„ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì˜¤ë¥˜: " + error.message);
     }
 });


</script>
</body>
</html>
